<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | Answer queries using the ledger state of the running node</span><span>
</span><span id="line-4"></span><span class="hs-comment">--</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- This allows queries from within the running node as opposed to submitting</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- queries via the LocalStateQuery protocol.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Node.Query</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Node.Query.html#answerQuery"><span class="hs-identifier">answerQuery</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Query.html#answerQueryWithLedgerState"><span class="hs-identifier">answerQueryWithLedgerState</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Query.html#InterpreterQuery"><span class="hs-identifier">InterpreterQuery</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Query.html#qryEpochStartTimeOfSlot"><span class="hs-identifier">qryEpochStartTimeOfSlot</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Query.html#getEpochStartTimeOfSlot"><span class="hs-identifier">getEpochStartTimeOfSlot</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Prelude</span></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-comment">-- Consensus</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BlockProtocol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SlotNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.BlockchainTime.WallClock.Types</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WCT</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Config</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TopLevelConfig</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">configLedger</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">configBlock</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Config.SupportsNode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">getSystemStart</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Combinator.Compat</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HF</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Combinator.Degenerate</span></span><span>
</span><span id="line-26"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HardForkLedgerConfig</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DegenLedgerConfig</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.HardFork.History.Qry</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HFI</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Query</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Consensus</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">answerQuery</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Query</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExtLedgerCfg</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ExtLedgerState</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Node</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RunNode</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Node.ProtocolInfo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pInfoConfig</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainDB</span></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">-- Byron</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Genesis</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Byron</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger.Conversions</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Byron</span></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">-- Shelley</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Shelley.Ledger</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">shelleyLedgerGenesis</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Shelley.Spec.Ledger.API</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SL</span></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- Cardano</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Cardano</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Consensus</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Cardano.ByronHFC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByronBlockHFC</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Cardano.ShelleyHFC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ShelleyBlockHFC</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Cardano.CanHardFork</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CanHardFork</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Cardano.Tracing.Kernel.html"><span class="hs-identifier">Cardano.Tracing.Kernel</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | Answer a general query about the current ledger state of the running node.</span><span>
</span><span id="line-51"></span><span class="annot"><a href="Cardano.Node.Query.html#answerQuery"><span class="hs-identifier hs-type">answerQuery</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679324985"><span class="annot"><a href="#local-6989586621679324985"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679324984"><span class="annot"><a href="#local-6989586621679324984"><span class="hs-identifier hs-type">result</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RunNode</span></span><span> </span><span class="annot"><a href="#local-6989586621679324985"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Consensus.Protocol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679324985"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockProtocol</span></span><span> </span><span class="annot"><a href="#local-6989586621679324985"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeKernel</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RemoteConnectionId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LocalConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679324985"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HF.HardForkCompatQuery</span></span><span> </span><span class="annot"><a href="#local-6989586621679324985"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679324984"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679324984"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-57"></span><span id="answerQuery"><span class="annot"><span class="annottext">answerQuery :: Protocol IO blk (BlockProtocol blk)
-&gt; NodeKernel IO RemoteConnectionId LocalConnectionId blk
-&gt; HardForkCompatQuery blk result
-&gt; IO result
</span><a href="Cardano.Node.Query.html#answerQuery"><span class="hs-identifier hs-var hs-var">answerQuery</span></a></span></span><span> </span><span id="local-6989586621679324954"><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324954"><span class="hs-identifier hs-var">protocol</span></a></span></span><span> </span><span id="local-6989586621679324953"><span class="annot"><span class="annottext">NodeKernel IO RemoteConnectionId LocalConnectionId blk
</span><a href="#local-6989586621679324953"><span class="hs-identifier hs-var">nodeKernel</span></a></span></span><span> </span><span id="local-6989586621679324952"><span class="annot"><span class="annottext">HardForkCompatQuery blk result
</span><a href="#local-6989586621679324952"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621679324951"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679324951"><span class="hs-identifier hs-var">extLedgerState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ExtLedgerState blk) -&gt; IO (ExtLedgerState blk)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (ExtLedgerState blk) -&gt; IO (ExtLedgerState blk))
-&gt; STM (ExtLedgerState blk) -&gt; IO (ExtLedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainDB IO blk -&gt; STM IO (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
(Monad (STM m), IsLedger (LedgerState blk)) =&gt;
ChainDB m blk -&gt; STM m (ExtLedgerState blk)
</span><span class="hs-identifier hs-var">ChainDB.getCurrentLedger</span></span><span> </span><span class="annot"><span class="annottext">ChainDB IO blk
</span><a href="#local-6989586621679324948"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="annottext">result -&gt; IO result
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(result -&gt; IO result) -&gt; result -&gt; IO result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
-&gt; ExtLedgerState blk -&gt; HardForkCompatQuery blk result -&gt; result
forall blk result.
RunNode blk =&gt;
Protocol IO blk (BlockProtocol blk)
-&gt; ExtLedgerState blk -&gt; HardForkCompatQuery blk result -&gt; result
</span><a href="Cardano.Node.Query.html#answerQueryWithLedgerState"><span class="hs-identifier hs-var">answerQueryWithLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324954"><span class="hs-identifier hs-var">protocol</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679324951"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">HardForkCompatQuery blk result
</span><a href="#local-6989586621679324952"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-61"></span><span>    </span><span id="local-6989586621679324948"><span class="annot"><span class="annottext">chainDB :: ChainDB IO blk
</span><a href="#local-6989586621679324948"><span class="hs-identifier hs-var hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeKernel IO RemoteConnectionId LocalConnectionId blk
-&gt; ChainDB IO blk
forall (m :: * -&gt; *) remotePeer localPeer blk.
NodeKernel m remotePeer localPeer blk -&gt; ChainDB m blk
</span><span class="hs-identifier hs-var hs-var">getChainDB</span></span><span> </span><span class="annot"><span class="annottext">NodeKernel IO RemoteConnectionId LocalConnectionId blk
</span><a href="#local-6989586621679324953"><span class="hs-identifier hs-var">nodeKernel</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- | Answer a general query about the given ledger state.</span><span>
</span><span id="line-64"></span><span class="annot"><a href="Cardano.Node.Query.html#answerQueryWithLedgerState"><span class="hs-identifier hs-type">answerQueryWithLedgerState</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679325073"><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679325071"><span class="annot"><a href="#local-6989586621679325071"><span class="hs-identifier hs-type">result</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RunNode</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Consensus.Protocol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockProtocol</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExtLedgerState</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HF.HardForkCompatQuery</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679325071"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325071"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-70"></span><span id="answerQueryWithLedgerState"><span class="annot"><span class="annottext">answerQueryWithLedgerState :: Protocol IO blk (BlockProtocol blk)
-&gt; ExtLedgerState blk -&gt; HardForkCompatQuery blk result -&gt; result
</span><a href="Cardano.Node.Query.html#answerQueryWithLedgerState"><span class="hs-identifier hs-var hs-var">answerQueryWithLedgerState</span></a></span></span><span> </span><span id="local-6989586621679324946"><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324946"><span class="hs-identifier hs-var">protocol</span></a></span></span><span> </span><span id="local-6989586621679324945"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679324945"><span class="hs-identifier hs-var">extLedgerState</span></a></span></span><span> </span><span id="local-6989586621679324944"><span class="annot"><span class="annottext">HardForkCompatQuery blk result
</span><a href="#local-6989586621679324944"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity result -&gt; result
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity result -&gt; result) -&gt; Identity result -&gt; result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324946"><span class="hs-identifier hs-var">protocol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-72"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Consensus.ProtocolByron</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-73"></span><span>        </span><span class="annot"><span class="annottext">Identity result
(blk ~ ByronBlockHFC) =&gt; Identity result
</span><a href="#local-6989586621679324941"><span class="hs-identifier hs-var">byronQuery</span></a></span><span>
</span><span id="line-74"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Consensus.ProtocolShelley</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-75"></span><span>        </span><span class="annot"><span class="annottext">Identity result
forall era. (blk ~ ShelleyBlockHFC era) =&gt; Identity result
</span><a href="#local-6989586621679324939"><span class="hs-identifier hs-var">shelleyBasedQuery</span></a></span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Consensus.ProtocolMary</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>        </span><span class="annot"><span class="annottext">Identity result
forall era. (blk ~ ShelleyBlockHFC era) =&gt; Identity result
</span><a href="#local-6989586621679324939"><span class="hs-identifier hs-var">shelleyBasedQuery</span></a></span><span>
</span><span id="line-78"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Consensus.ProtocolCardano</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="annottext">(forall result.
 Query
   (HardForkBlock
      '[ByronBlock, ShelleyBlock (ShelleyEra StandardCrypto),
        ShelleyBlock (AllegraEra StandardCrypto),
        ShelleyBlock (MaryEra StandardCrypto)])
   result
 -&gt; Identity result)
-&gt; HardForkCompatQuery
     (HardForkBlock
        '[ByronBlock, ShelleyBlock (ShelleyEra StandardCrypto),
          ShelleyBlock (AllegraEra StandardCrypto),
          ShelleyBlock (MaryEra StandardCrypto)])
     result
-&gt; Identity result
forall (m :: * -&gt; *) x (xs :: [*]).
IsNonEmpty xs =&gt;
(forall result. Query (HardForkBlock (x : xs)) result -&gt; m result)
-&gt; forall result.
   HardForkCompatQuery (HardForkBlock (x : xs)) result -&gt; m result
</span><span class="hs-identifier hs-var">HF.forwardCompatQuery</span></span><span>
</span><span id="line-80"></span><span>          </span><span class="annot"><span class="annottext">forall result.
Query
  (HardForkBlock
     '[ByronBlock, ShelleyBlock (ShelleyEra StandardCrypto),
       ShelleyBlock (AllegraEra StandardCrypto),
       ShelleyBlock (MaryEra StandardCrypto)])
  result
-&gt; Identity result
forall (m :: * -&gt; *) result'.
Monad m =&gt;
Query blk result' -&gt; m result'
</span><a href="#local-6989586621679324935"><span class="hs-identifier hs-var">answerQueryHelper</span></a></span><span>
</span><span id="line-81"></span><span>          </span><span class="annot"><span class="annottext">HardForkCompatQuery blk result
HardForkCompatQuery
  (HardForkBlock
     '[ByronBlock, ShelleyBlock (ShelleyEra StandardCrypto),
       ShelleyBlock (AllegraEra StandardCrypto),
       ShelleyBlock (MaryEra StandardCrypto)])
  result
</span><a href="#local-6989586621679324944"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="#local-6989586621679324934"><span class="hs-identifier hs-type">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TopLevelConfig</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621679324934"><span class="annot"><span class="annottext">cfg :: TopLevelConfig blk
</span><a href="#local-6989586621679324934"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo IO blk -&gt; TopLevelConfig blk
forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
</span><span class="hs-identifier hs-var hs-var">pInfoConfig</span></span><span> </span><span class="annot"><span class="annottext">(ProtocolInfo IO blk -&gt; TopLevelConfig blk)
-&gt; ProtocolInfo IO blk -&gt; TopLevelConfig blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk) -&gt; ProtocolInfo IO blk
forall (m :: * -&gt; *) blk p.
IOLike m =&gt;
Protocol m blk p -&gt; ProtocolInfo m blk
</span><span class="hs-identifier hs-var">Consensus.protocolInfo</span></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324946"><span class="hs-identifier hs-var">protocol</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="#local-6989586621679324935"><span class="hs-identifier hs-type">answerQueryHelper</span></a></span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679325045"><span class="annot"><a href="#local-6989586621679325045"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679325044"><span class="annot"><a href="#local-6989586621679325044"><span class="hs-identifier hs-type">result'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679325045"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Consensus.Query</span></span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679325044"><span class="hs-identifier hs-type">result'</span></a></span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679325045"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679325044"><span class="hs-identifier hs-type">result'</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621679324935"><span class="annot"><span class="annottext">answerQueryHelper :: Query blk result' -&gt; m result'
</span><a href="#local-6989586621679324935"><span class="hs-identifier hs-var hs-var">answerQueryHelper</span></a></span></span><span> </span><span id="local-6989586621679324932"><span class="annot"><span class="annottext">Query blk result'
</span><a href="#local-6989586621679324932"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">result' -&gt; m result'
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(result' -&gt; m result') -&gt; result' -&gt; m result'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">ExtLedgerCfg blk
-&gt; Query blk result' -&gt; ExtLedgerState blk -&gt; result'
forall blk result.
QueryLedger blk =&gt;
ExtLedgerCfg blk
-&gt; Query blk result -&gt; ExtLedgerState blk -&gt; result
</span><span class="hs-identifier hs-var">Consensus.answerQuery</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ExtLedgerCfg blk
forall blk. TopLevelConfig blk -&gt; ExtLedgerCfg blk
</span><span class="hs-identifier hs-var">ExtLedgerCfg</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679324934"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Query blk result'
</span><a href="#local-6989586621679324932"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679324945"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><a href="#local-6989586621679324941"><span class="hs-identifier hs-type">byronQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByronBlockHFC</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="annot"><a href="#local-6989586621679325071"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679324941"><span class="annot"><span class="annottext">byronQuery :: Identity result
</span><a href="#local-6989586621679324941"><span class="hs-identifier hs-var hs-var">byronQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="annottext">EpochSize
-&gt; SlotLength
-&gt; (forall result. Query blk result -&gt; Identity result)
-&gt; HardForkCompatQuery blk result
-&gt; Identity result
forall (m :: * -&gt; *) blk era.
(Monad m, HardForkIndices blk ~ '[era]) =&gt;
EpochSize
-&gt; SlotLength
-&gt; (forall result. Query blk result -&gt; m result)
-&gt; forall result. HardForkCompatQuery blk result -&gt; m result
</span><span class="hs-identifier hs-var">HF.singleEraCompatQuery</span></span><span>
</span><span id="line-96"></span><span>          </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679324929"><span class="hs-identifier hs-var">epochSize</span></a></span><span>
</span><span id="line-97"></span><span>          </span><span class="annot"><span class="annottext">SlotLength
</span><a href="#local-6989586621679324928"><span class="hs-identifier hs-var">slotLength</span></a></span><span>
</span><span id="line-98"></span><span>          </span><span class="annot"><span class="annottext">forall result. Query blk result -&gt; Identity result
forall (m :: * -&gt; *) result'.
Monad m =&gt;
Query blk result' -&gt; m result'
</span><a href="#local-6989586621679324935"><span class="hs-identifier hs-var">answerQueryHelper</span></a></span><span>
</span><span id="line-99"></span><span>          </span><span class="annot"><span class="annottext">HardForkCompatQuery blk result
</span><a href="#local-6989586621679324944"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DegenLedgerConfig</span></span><span> </span><span id="local-6989586621679324927"><span class="annot"><span class="annottext">PartialLedgerConfig ByronBlock
</span><a href="#local-6989586621679324927"><span class="hs-identifier hs-var">ledgerConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><span class="hs-identifier hs-var">configLedger</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679324934"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-102"></span><span>        </span><span id="local-6989586621679324926"><span class="annot"><span class="annottext">genesis :: LedgerConfig ByronBlock
</span><a href="#local-6989586621679324926"><span class="hs-identifier hs-var hs-var">genesis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByronPartialLedgerConfig -&gt; LedgerConfig ByronBlock
</span><span class="hs-identifier hs-var hs-var">CanHardFork.byronLedgerConfig</span></span><span> </span><span class="annot"><span class="annottext">PartialLedgerConfig ByronBlock
ByronPartialLedgerConfig
</span><a href="#local-6989586621679324927"><span class="hs-identifier hs-var">ledgerConfig</span></a></span><span>
</span><span id="line-103"></span><span>        </span><span id="local-6989586621679324929"><span class="annot"><span class="annottext">epochSize :: EpochSize
</span><a href="#local-6989586621679324929"><span class="hs-identifier hs-var hs-var">epochSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochSlots -&gt; EpochSize
</span><span class="hs-identifier hs-var">Byron.fromByronEpochSlots</span></span><span> </span><span class="annot"><span class="annottext">(EpochSlots -&gt; EpochSize) -&gt; EpochSlots -&gt; EpochSize
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Config -&gt; EpochSlots
</span><span class="hs-identifier hs-var">Byron.configEpochSlots</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig ByronBlock
Config
</span><a href="#local-6989586621679324926"><span class="hs-identifier hs-var">genesis</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span id="local-6989586621679324928"><span class="annot"><span class="annottext">slotLength :: SlotLength
</span><a href="#local-6989586621679324928"><span class="hs-identifier hs-var hs-var">slotLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; SlotLength
</span><span class="hs-identifier hs-var">Byron.fromByronSlotLength</span></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; SlotLength) -&gt; Natural -&gt; SlotLength
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Config -&gt; Natural
</span><span class="hs-identifier hs-var">Byron.genesisSlotLength</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig ByronBlock
Config
</span><a href="#local-6989586621679324926"><span class="hs-identifier hs-var">genesis</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621679325061"><span class="annot"><a href="#local-6989586621679324939"><span class="hs-identifier hs-type">shelleyBasedQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679325073"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShelleyBlockHFC</span></span><span> </span><span class="annot"><a href="#local-6989586621679325061"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="annot"><a href="#local-6989586621679325071"><span class="hs-identifier hs-type">result</span></a></span></span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621679324939"><span class="annot"><span class="annottext">shelleyBasedQuery :: Identity result
</span><a href="#local-6989586621679324939"><span class="hs-identifier hs-var hs-var">shelleyBasedQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-108"></span><span>        </span><span class="annot"><span class="annottext">EpochSize
-&gt; SlotLength
-&gt; (forall result. Query blk result -&gt; Identity result)
-&gt; HardForkCompatQuery blk result
-&gt; Identity result
forall (m :: * -&gt; *) blk era.
(Monad m, HardForkIndices blk ~ '[era]) =&gt;
EpochSize
-&gt; SlotLength
-&gt; (forall result. Query blk result -&gt; m result)
-&gt; forall result. HardForkCompatQuery blk result -&gt; m result
</span><span class="hs-identifier hs-var">HF.singleEraCompatQuery</span></span><span>
</span><span id="line-109"></span><span>          </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679324920"><span class="hs-identifier hs-var">epochSize</span></a></span><span>
</span><span id="line-110"></span><span>          </span><span class="annot"><span class="annottext">SlotLength
</span><a href="#local-6989586621679324919"><span class="hs-identifier hs-var">slotLength</span></a></span><span>
</span><span id="line-111"></span><span>          </span><span class="annot"><span class="annottext">forall result. Query blk result -&gt; Identity result
forall (m :: * -&gt; *) result'.
Monad m =&gt;
Query blk result' -&gt; m result'
</span><a href="#local-6989586621679324935"><span class="hs-identifier hs-var">answerQueryHelper</span></a></span><span>
</span><span id="line-112"></span><span>          </span><span class="annot"><span class="annottext">HardForkCompatQuery blk result
</span><a href="#local-6989586621679324944"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-114"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DegenLedgerConfig</span></span><span> </span><span id="local-6989586621679324918"><span class="annot"><span class="annottext">PartialLedgerConfig (ShelleyBlock era)
</span><a href="#local-6989586621679324918"><span class="hs-identifier hs-var">ledgerConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><span class="hs-identifier hs-var">configLedger</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679324934"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-115"></span><span>        </span><span id="local-6989586621679324917"><span class="annot"><span class="annottext">genesis :: ShelleyGenesis era
</span><a href="#local-6989586621679324917"><span class="hs-identifier hs-var hs-var">genesis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShelleyLedgerConfig era -&gt; ShelleyGenesis era
forall era. ShelleyLedgerConfig era -&gt; ShelleyGenesis era
</span><span class="hs-identifier hs-var">shelleyLedgerGenesis</span></span><span> </span><span class="annot"><span class="annottext">(ShelleyLedgerConfig era -&gt; ShelleyGenesis era)
-&gt; ShelleyLedgerConfig era -&gt; ShelleyGenesis era
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-116"></span><span>                    </span><span class="annot"><span class="annottext">ShelleyPartialLedgerConfig era -&gt; ShelleyLedgerConfig era
forall era.
ShelleyPartialLedgerConfig era -&gt; ShelleyLedgerConfig era
</span><span class="hs-identifier hs-var hs-var">CanHardFork.shelleyLedgerConfig</span></span><span> </span><span class="annot"><span class="annottext">PartialLedgerConfig (ShelleyBlock era)
ShelleyPartialLedgerConfig era
</span><a href="#local-6989586621679324918"><span class="hs-identifier hs-var">ledgerConfig</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span id="local-6989586621679324920"><span class="annot"><span class="annottext">epochSize :: EpochSize
</span><a href="#local-6989586621679324920"><span class="hs-identifier hs-var hs-var">epochSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShelleyGenesis era -&gt; EpochSize
forall era. ShelleyGenesis era -&gt; EpochSize
</span><span class="hs-identifier hs-var hs-var">SL.sgEpochLength</span></span><span> </span><span class="annot"><span class="annottext">ShelleyGenesis era
</span><a href="#local-6989586621679324917"><span class="hs-identifier hs-var">genesis</span></a></span><span>
</span><span id="line-118"></span><span>        </span><span id="local-6989586621679324919"><span class="annot"><span class="annottext">slotLength :: SlotLength
</span><a href="#local-6989586621679324919"><span class="hs-identifier hs-var hs-var">slotLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; SlotLength
</span><span class="hs-identifier hs-var">WCT.mkSlotLength</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; SlotLength) -&gt; NominalDiffTime -&gt; SlotLength
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShelleyGenesis era -&gt; NominalDiffTime
forall era. ShelleyGenesis era -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var hs-var">SL.sgSlotLength</span></span><span> </span><span class="annot"><span class="annottext">ShelleyGenesis era
</span><a href="#local-6989586621679324917"><span class="hs-identifier hs-var">genesis</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | To avoid confusing 'HFI.Qry' with 'HF.Query' and 'HF.HardForkCompatQuery,</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- we introduce a type synonym for the former which we can use in docstrings</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- (and type signatures, of course).</span><span>
</span><span id="line-123"></span><span class="hs-comment">--</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- * 'HFI.Qry' (and thus 'InterpreterQuery') is a query about slots/epochs/time</span><span>
</span><span id="line-125"></span><span class="hs-comment">--   that a 'HF.Interpreter' can answer.</span><span>
</span><span id="line-126"></span><span class="hs-comment">--</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- * 'Consensus.Query' and 'HF.HardForkCompatQuery' are more general queries</span><span>
</span><span id="line-128"></span><span class="hs-comment">--   that can ask for anything related to the ledger state.</span><span>
</span><span id="line-129"></span><span class="hs-keyword">type</span><span> </span><span id="InterpreterQuery"><span class="annot"><a href="Cardano.Node.Query.html#InterpreterQuery"><span class="hs-identifier hs-var">InterpreterQuery</span></a></span></span><span> </span><span id="local-6989586621679324912"><span class="annot"><a href="#local-6989586621679324912"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HFI.Qry</span></span><span> </span><span class="annot"><a href="#local-6989586621679324912"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Return the start time of the epoch of the given slot.</span><span>
</span><span id="line-132"></span><span class="annot"><a href="Cardano.Node.Query.html#qryEpochStartTimeOfSlot"><span class="hs-identifier hs-type">qryEpochStartTimeOfSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Query.html#InterpreterQuery"><span class="hs-identifier hs-type">InterpreterQuery</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WCT.RelativeTime</span></span><span>
</span><span id="line-133"></span><span id="qryEpochStartTimeOfSlot"><span class="annot"><span class="annottext">qryEpochStartTimeOfSlot :: SlotNo -&gt; InterpreterQuery RelativeTime
</span><a href="Cardano.Node.Query.html#qryEpochStartTimeOfSlot"><span class="hs-identifier hs-var hs-var">qryEpochStartTimeOfSlot</span></a></span></span><span> </span><span id="local-6989586621679324911"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679324911"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (f :: * -&gt; *). Expr f RelativeTime)
-&gt; InterpreterQuery RelativeTime
forall a. (forall (f :: * -&gt; *). Expr f a) -&gt; Qry a
</span><span class="hs-identifier hs-var">HFI.qryFromExpr</span></span><span> </span><span class="annot"><span class="annottext">((forall (f :: * -&gt; *). Expr f RelativeTime)
 -&gt; InterpreterQuery RelativeTime)
-&gt; (forall (f :: * -&gt; *). Expr f RelativeTime)
-&gt; InterpreterQuery RelativeTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">Expr f SlotInEra
-&gt; (f SlotInEra -&gt; Expr f RelativeTime) -&gt; Expr f RelativeTime
forall (f :: * -&gt; *) a1 a.
Expr f a1 -&gt; (f a1 -&gt; Expr f a) -&gt; Expr f a
</span><span class="hs-identifier hs-var">HFI.ELet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr f SlotNo -&gt; Expr f SlotInEra
forall (f :: * -&gt; *). Expr f SlotNo -&gt; Expr f SlotInEra
</span><span class="hs-identifier hs-var">HFI.EAbsToRelSlot</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Expr f SlotNo
forall a (f :: * -&gt; *). Show a =&gt; a -&gt; Expr f a
</span><span class="hs-identifier hs-var">HFI.ELit</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679324911"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((f SlotInEra -&gt; Expr f RelativeTime) -&gt; Expr f RelativeTime)
-&gt; (f SlotInEra -&gt; Expr f RelativeTime) -&gt; Expr f RelativeTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679324906"><span class="annot"><span class="annottext">f SlotInEra
</span><a href="#local-6989586621679324906"><span class="hs-identifier hs-var">slotInEra</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><span class="annottext">Expr f TimeInEra
-&gt; (f TimeInEra -&gt; Expr f RelativeTime) -&gt; Expr f RelativeTime
forall (f :: * -&gt; *) a1 a.
Expr f a1 -&gt; (f a1 -&gt; Expr f a) -&gt; Expr f a
</span><span class="hs-identifier hs-var">HFI.ELet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr f SlotInEra -&gt; Expr f TimeInEra
forall (f :: * -&gt; *). Expr f SlotInEra -&gt; Expr f TimeInEra
</span><span class="hs-identifier hs-var">HFI.ERelSlotToTime</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f SlotInEra -&gt; Expr f SlotInEra
forall (f :: * -&gt; *) a. f a -&gt; Expr f a
</span><span class="hs-identifier hs-var">HFI.EVar</span></span><span> </span><span class="annot"><span class="annottext">f SlotInEra
</span><a href="#local-6989586621679324906"><span class="hs-identifier hs-var">slotInEra</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((f TimeInEra -&gt; Expr f RelativeTime) -&gt; Expr f RelativeTime)
-&gt; (f TimeInEra -&gt; Expr f RelativeTime) -&gt; Expr f RelativeTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679324903"><span class="annot"><span class="annottext">f TimeInEra
</span><a href="#local-6989586621679324903"><span class="hs-identifier hs-var">timeInEra</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">Expr f TimeInEra -&gt; Expr f RelativeTime
forall (f :: * -&gt; *). Expr f TimeInEra -&gt; Expr f RelativeTime
</span><span class="hs-identifier hs-var">HFI.ERelToAbsTime</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f TimeInEra -&gt; Expr f TimeInEra
forall (f :: * -&gt; *) a. f a -&gt; Expr f a
</span><span class="hs-identifier hs-var">HFI.EVar</span></span><span> </span><span class="annot"><span class="annottext">f TimeInEra
</span><a href="#local-6989586621679324903"><span class="hs-identifier hs-var">timeInEra</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">-- | Execute the 'qryEpochStartTimeOfSlot' 'InterpreterQuery' against the</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- current ledger state.</span><span>
</span><span id="line-140"></span><span class="hs-comment">--</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- Will return a 'HF.PastHorizonException' when the current chain doesn't give</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- us enough information about the given slot. For example, when syncing from</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- scratch, we don't know yet when the transition to Shelley will happen, so we</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- can't do conversions for slots from the Shelley era.</span><span>
</span><span id="line-145"></span><span class="annot"><a href="Cardano.Node.Query.html#getEpochStartTimeOfSlot"><span class="hs-identifier hs-type">getEpochStartTimeOfSlot</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679324901"><span class="annot"><a href="#local-6989586621679324901"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>  </span><span class="annot"><span class="hs-identifier hs-type">RunNode</span></span><span> </span><span class="annot"><a href="#local-6989586621679324901"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Consensus.Protocol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679324901"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockProtocol</span></span><span> </span><span class="annot"><a href="#local-6989586621679324901"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeKernel</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RemoteConnectionId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LocalConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679324901"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HFI.PastHorizonException</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span id="getEpochStartTimeOfSlot"><span class="annot"><span class="annottext">getEpochStartTimeOfSlot :: Protocol IO blk (BlockProtocol blk)
-&gt; NodeKernel IO RemoteConnectionId LocalConnectionId blk
-&gt; SlotNo
-&gt; IO (Either PastHorizonException UTCTime)
</span><a href="Cardano.Node.Query.html#getEpochStartTimeOfSlot"><span class="hs-identifier hs-var hs-var">getEpochStartTimeOfSlot</span></a></span></span><span> </span><span id="local-6989586621679324900"><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324900"><span class="hs-identifier hs-var">protocol</span></a></span></span><span> </span><span id="local-6989586621679324899"><span class="annot"><span class="annottext">NodeKernel IO RemoteConnectionId LocalConnectionId blk
</span><a href="#local-6989586621679324899"><span class="hs-identifier hs-var">nodeKernel</span></a></span></span><span> </span><span id="local-6989586621679324898"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679324898"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621679324897"><span class="annot"><span class="annottext">Interpreter (HardForkIndices blk)
</span><a href="#local-6989586621679324897"><span class="hs-identifier hs-var">interpreter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
-&gt; NodeKernel IO RemoteConnectionId LocalConnectionId blk
-&gt; HardForkCompatQuery blk (Interpreter (HardForkIndices blk))
-&gt; IO (Interpreter (HardForkIndices blk))
forall blk result.
RunNode blk =&gt;
Protocol IO blk (BlockProtocol blk)
-&gt; NodeKernel IO RemoteConnectionId LocalConnectionId blk
-&gt; HardForkCompatQuery blk result
-&gt; IO result
</span><a href="Cardano.Node.Query.html#answerQuery"><span class="hs-identifier hs-var">answerQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324900"><span class="hs-identifier hs-var">protocol</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel IO RemoteConnectionId LocalConnectionId blk
</span><a href="#local-6989586621679324899"><span class="hs-identifier hs-var">nodeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">HardForkCompatQuery blk (Interpreter (HardForkIndices blk))
forall blk.
HardForkCompatQuery blk (Interpreter (HardForkIndices blk))
</span><span class="hs-identifier hs-var">HF.compatGetInterpreter</span></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-comment">-- NOTE: ask for an interpreter sparingly, as it is not super cheap. You can</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-comment">-- use that same interpreter to answer many queries.</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-comment">-- When the interpreter returns 'HFI.PastHorizonException' for a certain</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- 'InterpreterQuery', try obtaining a new interpreter. The chain might have</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-comment">-- advanced and the new ledger state might contain more information so that</span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-comment">-- the 'InterpreterQuery' /can/ be answered.</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-comment">-- For example, when starting up with an empty chain, the interpreter</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- obtained from the empty ledger state won't be able to answer queries</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- about the a slot from the Shelley era, as it doesn't know when the</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">-- Shelley transition takes place. So while the node is syncing, you can</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- periodically try to obtain a new interpreter whenever it returns</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- 'HFI.PastHorizonException'. Note that doing this after every new block is</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- pointless and wasteful. Doing it when the ledger hasn't changed is even</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- more pointless.</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">Either PastHorizonException UTCTime
-&gt; IO (Either PastHorizonException UTCTime)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either PastHorizonException UTCTime
 -&gt; IO (Either PastHorizonException UTCTime))
-&gt; Either PastHorizonException UTCTime
-&gt; IO (Either PastHorizonException UTCTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">SystemStart -&gt; RelativeTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">WCT.fromRelativeTime</span></span><span> </span><span class="annot"><span class="annottext">SystemStart
</span><a href="#local-6989586621679324894"><span class="hs-identifier hs-var">systemStart</span></a></span><span> </span><span class="annot"><span class="annottext">(RelativeTime -&gt; UTCTime)
-&gt; Either PastHorizonException RelativeTime
-&gt; Either PastHorizonException UTCTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><span class="annottext">Interpreter (HardForkIndices blk)
-&gt; InterpreterQuery RelativeTime
-&gt; Either PastHorizonException RelativeTime
forall (xs :: [*]) a.
HasCallStack =&gt;
Interpreter xs -&gt; Qry a -&gt; Either PastHorizonException a
</span><span class="hs-identifier hs-var">HFI.interpretQuery</span></span><span> </span><span class="annot"><span class="annottext">Interpreter (HardForkIndices blk)
</span><a href="#local-6989586621679324897"><span class="hs-identifier hs-var">interpreter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; InterpreterQuery RelativeTime
</span><a href="Cardano.Node.Query.html#qryEpochStartTimeOfSlot"><span class="hs-identifier hs-var">qryEpochStartTimeOfSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679324898"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621679324894"><span class="annot"><span class="annottext">systemStart :: SystemStart
</span><a href="#local-6989586621679324894"><span class="hs-identifier hs-var hs-var">systemStart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>          </span><span class="annot"><span class="annottext">BlockConfig blk -&gt; SystemStart
forall blk.
ConfigSupportsNode blk =&gt;
BlockConfig blk -&gt; SystemStart
</span><span class="hs-identifier hs-var">getSystemStart</span></span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">(BlockConfig blk -&gt; SystemStart)
-&gt; (Protocol IO blk (BlockProtocol blk) -&gt; BlockConfig blk)
-&gt; Protocol IO blk (BlockProtocol blk)
-&gt; SystemStart
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><span class="hs-identifier hs-var">configBlock</span></span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">(TopLevelConfig blk -&gt; BlockConfig blk)
-&gt; (Protocol IO blk (BlockProtocol blk) -&gt; TopLevelConfig blk)
-&gt; Protocol IO blk (BlockProtocol blk)
-&gt; BlockConfig blk
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ProtocolInfo IO blk -&gt; TopLevelConfig blk
forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
</span><span class="hs-identifier hs-var hs-var">pInfoConfig</span></span><span>
</span><span id="line-177"></span><span>        </span><span class="annot"><span class="annottext">(ProtocolInfo IO blk -&gt; TopLevelConfig blk)
-&gt; (Protocol IO blk (BlockProtocol blk) -&gt; ProtocolInfo IO blk)
-&gt; Protocol IO blk (BlockProtocol blk)
-&gt; TopLevelConfig blk
forall k (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk) -&gt; ProtocolInfo IO blk
forall (m :: * -&gt; *) blk p.
IOLike m =&gt;
Protocol m blk p -&gt; ProtocolInfo m blk
</span><span class="hs-identifier hs-var">Consensus.protocolInfo</span></span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><span class="annottext">(Protocol IO blk (BlockProtocol blk) -&gt; SystemStart)
-&gt; Protocol IO blk (BlockProtocol blk) -&gt; SystemStart
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Protocol IO blk (BlockProtocol blk)
</span><a href="#local-6989586621679324900"><span class="hs-identifier hs-var">protocol</span></a></span><span>
</span><span id="line-179"></span></pre></body></html>